name: Daily Research Note Generator

on:
  # Daily at 23:59 KST (14:59 UTC)
  schedule:
    - cron: '59 14 * * *'
  # Manual trigger
  workflow_dispatch:
    inputs:
      project:
        description: 'Specific project to process (leave empty for all)'
        required: false
        default: ''
      dry_run:
        description: 'Dry run mode'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: write

jobs:
  generate-note:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git diff

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install pyyaml

      # ── AI Backend Setup ──────────────────────────────────
      # Priority: Claude CLI → Anthropic API → Ollama → none
      # The script handles this automatically with ai_backend: "auto"

      - name: Check Claude CLI availability
        id: check_claude
        continue-on-error: true
        run: |
          if command -v claude &> /dev/null; then
            echo "available=true" >> "$GITHUB_OUTPUT"
            echo "[AI] Claude CLI available"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
            echo "[AI] Claude CLI not found"
          fi

      - name: Check Anthropic API key
        id: check_api
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
            echo "[AI] Anthropic API key configured"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
            echo "[AI] No Anthropic API key"
          fi

      - name: Install & start Ollama (fallback)
        id: setup_ollama
        if: steps.check_claude.outputs.available != 'true' && steps.check_api.outputs.available != 'true'
        run: |
          echo "[AI] No Claude/API available → installing Ollama as fallback..."
          curl -fsSL https://ollama.com/install.sh | sh

          # Start ollama server in background
          ollama serve &
          OLLAMA_PID=$!
          echo "ollama_pid=$OLLAMA_PID" >> "$GITHUB_OUTPUT"

          # Wait for server to be ready
          for i in $(seq 1 30); do
            if curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
              echo "[AI] Ollama server ready"
              break
            fi
            sleep 1
          done

          # Pull model (use small model for CI speed)
          echo "[AI] Pulling model..."
          ollama pull llama3.2:3b
          echo "available=true" >> "$GITHUB_OUTPUT"

      - name: Generate research notes
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ARGS=""
          if [ "${{ github.event.inputs.project }}" != "" ]; then
            ARGS="--project ${{ github.event.inputs.project }}"
          fi
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          python generate_note.py --verbose $ARGS

      - name: Stop Ollama (if started)
        if: always() && steps.setup_ollama.outputs.ollama_pid != ''
        run: kill ${{ steps.setup_ollama.outputs.ollama_pid }} || true

      - name: Commit and push changes
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "Research Note Bot"
          git config user.email "research-note-bot@users.noreply.github.com"
          git add -A "*.md"
          git diff --cached --quiet || git commit -m "docs: auto-generate daily research note ($(date +%Y-%m-%d))"
          git push
